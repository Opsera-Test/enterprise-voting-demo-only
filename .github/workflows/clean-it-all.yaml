# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  CLEAN IT ALL - Resource cleanup workflow (RULE 16)                          â•‘
# â•‘  Deletes all resources created by the deployment                             â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ§¹ Clean It All"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to clean'
        required: true
        type: string
        default: 'dev'
      tenant:
        description: 'Tenant/Organization name'
        required: true
        type: string
        default: 'opsera'
      confirm_delete:
        description: 'Type DELETE to confirm'
        required: true
        type: string

env:
  AWS_REGION: us-west-2
  APP_NAME: voting-app
  TENANT: ${{ inputs.tenant }}
  ENVIRONMENT: ${{ inputs.environment }}

permissions:
  contents: write
  id-token: write

jobs:
  confirm:
    name: "âš ï¸ Confirm Deletion"
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.check.outputs.confirmed }}
      
    steps:
      - name: Check Confirmation
        id: check
        run: |
          if [ "${{ inputs.confirm_delete }}" = "DELETE" ]; then
            echo "confirmed=true" >> $GITHUB_OUTPUT
            echo "âœ… Deletion confirmed"
          else
            echo "confirmed=false" >> $GITHUB_OUTPUT
            echo "âŒ Confirmation failed. You must type DELETE to proceed."
            exit 1
          fi

  cleanup:
    name: "ðŸ§¹ Cleanup Resources"
    runs-on: ubuntu-latest
    needs: [confirm]
    if: needs.confirm.outputs.confirmed == 'true'
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl (RULE 25)
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Generate Names
        id: names
        run: |
          case "${{ env.AWS_REGION }}" in
            us-west-2) REGION_SHORT="usw2" ;;
            us-east-1) REGION_SHORT="use1" ;;
            *) REGION_SHORT=$(echo "${{ env.AWS_REGION }}" | sed 's/-//g' | cut -c1-4) ;;
          esac
          
          HUB_CLUSTER="argocd-${REGION_SHORT}"
          
          if [ "${{ env.ENVIRONMENT }}" = "prod" ]; then
            SPOKE_CLUSTER="${{ env.TENANT }}-${REGION_SHORT}-prod"
          else
            SPOKE_CLUSTER="${{ env.TENANT }}-${REGION_SHORT}-np"
          fi
          
          NAMESPACE="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          
          echo "hub_cluster=${HUB_CLUSTER}" >> $GITHUB_OUTPUT
          echo "spoke_cluster=${SPOKE_CLUSTER}" >> $GITHUB_OUTPUT
          echo "namespace=${NAMESPACE}" >> $GITHUB_OUTPUT

      - name: Delete ArgoCD Application
        run: |
          echo "ðŸ—‘ï¸ Deleting ArgoCD Application..."
          aws eks update-kubeconfig --name ${{ steps.names.outputs.hub_cluster }} --region ${{ env.AWS_REGION }}
          
          kubectl delete application ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -n argocd --ignore-not-found=true
          echo "âœ… ArgoCD Application deleted"

      - name: Delete Kubernetes Namespace
        run: |
          echo "ðŸ—‘ï¸ Deleting Kubernetes Namespace..."
          aws eks update-kubeconfig --name ${{ steps.names.outputs.spoke_cluster }} --region ${{ env.AWS_REGION }}
          
          kubectl delete namespace ${{ steps.names.outputs.namespace }} --ignore-not-found=true --timeout=120s || true
          echo "âœ… Kubernetes Namespace deleted"

      - name: Delete ECR Repositories
        run: |
          echo "ðŸ—‘ï¸ Deleting ECR Repositories..."
          for SERVICE in vote result worker; do
            aws ecr delete-repository --repository-name $SERVICE --force 2>/dev/null || echo "Repository $SERVICE not found or already deleted"
          done
          echo "âœ… ECR Repositories deleted"

      - name: Summary
        run: |
          echo "## ðŸ§¹ Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deleted Resources" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ArgoCD Application: \`${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Kubernetes Namespace: \`${{ steps.names.outputs.namespace }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECR Repositories: \`vote\`, \`result\`, \`worker\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Note" >> $GITHUB_STEP_SUMMARY
          echo "DNS records and certificates will be automatically cleaned up by cert-manager." >> $GITHUB_STEP_SUMMARY
