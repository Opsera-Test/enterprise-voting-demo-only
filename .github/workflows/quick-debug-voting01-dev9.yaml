# Quick debug for voting01-dev9
name: "Quick Debug (voting01-dev9)"

on:
  workflow_dispatch:

env:
  APP_NAME: voting01
  ENVIRONMENT: dev9
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  HUB_CLUSTER: argocd-usw2

jobs:
  debug:
    name: "Debug dev9"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ArgoCD App Status
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "### ArgoCD Application Status" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get application ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -n argocd -o wide 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "### ArgoCD Sync Status" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get application ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -n argocd -o jsonpath='{.status.sync.status}' 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "### ArgoCD Health Status" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get application ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -n argocd -o jsonpath='{.status.health.status}' 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "### ArgoCD Conditions" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get application ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -n argocd -o jsonpath='{.status.conditions}' 2>&1 | tee -a $GITHUB_STEP_SUMMARY

      - name: Pod Status
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          echo "### All Resources in ${NS}" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get all -n $NS 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "### Pod Describe" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl describe pods -n $NS 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Pod Logs - Result
        run: |
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          echo "### Result Pod Logs" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -n $NS -l app=result --tail=50 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "### Result Previous Logs" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -n $NS -l app=result --tail=50 --previous 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Pod Logs - Vote
        run: |
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          echo "### Vote Pod Logs" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -n $NS -l app=vote --tail=30 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Pod Logs - Worker
        run: |
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          echo "### Worker Pod Logs" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -n $NS -l app=worker --tail=30 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Events
        run: |
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          echo "### Recent Events" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n $NS --sort-by='.lastTimestamp' 2>&1 | tail -30 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Ingress & Services
        run: |
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"
          echo "### Services" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n $NS -o wide 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "### Ingress" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n $NS -o wide 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "### ConfigMap" | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get configmap voting01-config -n $NS -o yaml 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
