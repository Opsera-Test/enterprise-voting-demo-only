# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CI BUILD & DEPLOY - voting01 QA (Canary)
# MANUAL GATE: Requires manual trigger from GitHub Actions UI
# Progressive rollout: 20% â†’ 50% â†’ 100% with New Relic analysis
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸš€ Promote to QA"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag from DEV (check DEV kustomization.yaml)'
        required: true
        type: string
      runner:
        description: 'Runner type'
        type: choice
        options: ['github-hosted', 'self-hosted']
        default: 'github-hosted'

env:
  APP_NAME: voting01
  ENVIRONMENT: qa
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: write
  actions: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GET IMAGE TAG
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  get-tag:
    name: "ğŸ·ï¸ Validate Image Tag"
    runs-on: ${{ github.event.inputs.runner == 'self-hosted' && fromJSON('["self-hosted", "linux", "opsera"]') || 'ubuntu-latest' }}
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate Image Tag
        id: tag
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          if [ -z "$TAG" ]; then
            echo "âŒ Error: Image tag is required"
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "### ğŸš€ Promoting to QA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`$TAG\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Manual Promotion |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY TO QA (CANARY)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deploy:
    name: "ğŸš€ Deploy QA (Canary)"
    needs: [get-tag]
    runs-on: ${{ github.event.inputs.runner == 'self-hosted' && fromJSON('["self-hosted", "linux", "opsera"]') || 'ubuntu-latest' }}
    outputs:
      success: ${{ steps.verify.outputs.success }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Update Kustomization
        run: |
          cd .opsera-voting01/k8s/overlays/${{ env.ENVIRONMENT }}
          sed -i "s|newTag:.*|newTag: ${{ needs.get-tag.outputs.image_tag }}|g" kustomization.yaml

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .opsera-voting01/
          git diff --cached --quiet || git commit -m "deploy(voting01-qa): ${{ needs.get-tag.outputs.image_tag }} [skip ci]"
          git pull --rebase origin main
          git push origin main

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup New Relic Secret
        env:
          NEW_RELIC_LICENSE_KEY: ${{ secrets.NEW_RELIC_LICENSE_KEY }}
        run: |
          if [ -z "$NEW_RELIC_LICENSE_KEY" ]; then
            echo "âš ï¸ NEW_RELIC_LICENSE_KEY not configured - skipping New Relic setup" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          # Create namespace if it doesn't exist
          kubectl get namespace $NS || kubectl create namespace $NS

          # Create or update the New Relic license secret
          kubectl create secret generic newrelic-license \
            --from-literal=NEW_RELIC_LICENSE_KEY="$NEW_RELIC_LICENSE_KEY" \
            --namespace=$NS \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "âœ… New Relic secret configured for $NS" >> $GITHUB_STEP_SUMMARY

      - name: Trigger ArgoCD Sync
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          kubectl annotate application ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -n argocd argocd.argoproj.io/refresh=hard --overwrite

      - name: Query New Relic Baseline Metrics
        id: nr_baseline
        continue-on-error: true
        run: |
          echo "### ğŸ“Š New Relic APM Baseline Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Query mock New Relic server for baseline metrics
          NR_HOST="opsera-opsera-newrelic-dev.agent.opsera.dev"

          echo "Querying baseline metrics from New Relic mock server..."

          # Get vote service metrics
          VOTE_METRICS=$(curl -s --max-time 10 \
            "https://${NR_HOST}/v1/metrics?app=voting01-vote-qa&metric=errorRate&window=5m" \
            2>/dev/null || echo '{"errorRate": 0}')
          VOTE_ERROR=$(echo "$VOTE_METRICS" | grep -oE '"errorRate"[[:space:]]*:[[:space:]]*[0-9.]+' | grep -oE '[0-9.]+$' || echo "0")

          # Get result service metrics
          RESULT_METRICS=$(curl -s --max-time 10 \
            "https://${NR_HOST}/v1/metrics?app=voting01-result-qa&metric=errorRate&window=5m" \
            2>/dev/null || echo '{"errorRate": 0}')
          RESULT_ERROR=$(echo "$RESULT_METRICS" | grep -oE '"errorRate"[[:space:]]*:[[:space:]]*[0-9.]+' | grep -oE '[0-9.]+$' || echo "0")

          echo "| Service | Error Rate | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------------|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check vote error rate
          if [ "$(echo "$VOTE_ERROR < 2" | bc -l 2>/dev/null || echo 1)" = "1" ]; then
            echo "| Vote | ${VOTE_ERROR:-0}% | 2% | âœ… OK |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Vote | ${VOTE_ERROR:-0}% | 2% | âš ï¸ High |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check result error rate
          if [ "$(echo "$RESULT_ERROR < 2" | bc -l 2>/dev/null || echo 1)" = "1" ]; then
            echo "| Result | ${RESULT_ERROR:-0}% | 2% | âœ… OK |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Result | ${RESULT_ERROR:-0}% | 2% | âš ï¸ High |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Metrics from New Relic Mock Server: ${NR_HOST}_" >> $GITHUB_STEP_SUMMARY

      - name: Live Canary Dashboard
        id: verify
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    ğŸš€ QA CANARY DEPLOYMENT LIVE DASHBOARD                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ App: voting01                    Environment: QA                             â•‘"
          echo "â•‘ Strategy: Canary (20% â†’ 50% â†’ 100%)                                          â•‘"
          echo "â•‘ Analysis: HTTP Health + New Relic Error Rate (< 2%)                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Initialize step summary
          echo "### ğŸ¯ QA Canary Deployment Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Traffic | Analysis |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|----------|" >> $GITHUB_STEP_SUMMARY

          MAX_ITERATIONS=80
          POLL_INTERVAL=15

          for i in $(seq 1 $MAX_ITERATIONS); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Poll $i/$MAX_ITERATIONS - $(date '+%H:%M:%S')"
            echo ""

            # Get detailed rollout status for vote
            VOTE_PHASE=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            VOTE_WEIGHT=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.canary.weights.canary}' 2>/dev/null || echo "0")
            VOTE_STABLE=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.canary.weights.stable}' 2>/dev/null || echo "100")
            VOTE_STEP=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.currentStepIndex}' 2>/dev/null || echo "0")
            VOTE_MSG=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.message}' 2>/dev/null || echo "")

            # Get detailed rollout status for result
            RESULT_PHASE=$(kubectl get rollout result -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            RESULT_WEIGHT=$(kubectl get rollout result -n $NS -o jsonpath='{.status.canary.weights.canary}' 2>/dev/null || echo "0")
            RESULT_STABLE=$(kubectl get rollout result -n $NS -o jsonpath='{.status.canary.weights.stable}' 2>/dev/null || echo "100")
            RESULT_STEP=$(kubectl get rollout result -n $NS -o jsonpath='{.status.currentStepIndex}' 2>/dev/null || echo "0")

            # Get worker status (simpler canary)
            WORKER_PHASE=$(kubectl get rollout worker -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")

            # Display vote rollout
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ğŸ—³ï¸  VOTE SERVICE                                                            â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            printf "â”‚ Phase: %-12s  Step: %-3s  Canary: %3s%%  Stable: %3s%%              â”‚\n" "$VOTE_PHASE" "$VOTE_STEP" "${VOTE_WEIGHT:-0}" "${VOTE_STABLE:-100}"
            [ -n "$VOTE_MSG" ] && echo "â”‚ Message: $VOTE_MSG"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

            # Display result rollout
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ ğŸ“Š RESULT SERVICE                                                           â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            printf "â”‚ Phase: %-12s  Step: %-3s  Canary: %3s%%  Stable: %3s%%              â”‚\n" "$RESULT_PHASE" "$RESULT_STEP" "${RESULT_WEIGHT:-0}" "${RESULT_STABLE:-100}"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

            # Display worker rollout
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ âš™ï¸  WORKER SERVICE                                                          â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            printf "â”‚ Phase: %-12s                                                        â”‚\n" "$WORKER_PHASE"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

            # Check for analysis runs
            echo ""
            echo "ğŸ“ˆ Active Analysis Runs:"
            ANALYSIS_RUNS=$(kubectl get analysisrun -n $NS -l rollouts-pod-template-hash --sort-by=.metadata.creationTimestamp 2>/dev/null | tail -5 || echo "None found")
            echo "$ANALYSIS_RUNS"

            # Check latest analysis run result
            LATEST_AR=$(kubectl get analysisrun -n $NS -l rollouts-pod-template-hash -o jsonpath='{.items[-1].metadata.name}' 2>/dev/null || echo "")
            if [ -n "$LATEST_AR" ]; then
              AR_PHASE=$(kubectl get analysisrun $LATEST_AR -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
              AR_MSG=$(kubectl get analysisrun $LATEST_AR -n $NS -o jsonpath='{.status.message}' 2>/dev/null || echo "")
              echo ""
              echo "ğŸ”¬ Latest Analysis: $LATEST_AR"
              echo "   Status: $AR_PHASE"
              [ -n "$AR_MSG" ] && echo "   Message: $AR_MSG"
            fi

            # Check for success
            if [ "$VOTE_PHASE" = "Healthy" ] && [ "$RESULT_PHASE" = "Healthy" ] && [ "$WORKER_PHASE" = "Healthy" ]; then
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘                    âœ… CANARY DEPLOYMENT SUCCESSFUL!                          â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

              # Update summary with final status
              echo "| Vote | âœ… Healthy | 100% | Passed |" >> $GITHUB_STEP_SUMMARY
              echo "| Result | âœ… Healthy | 100% | Passed |" >> $GITHUB_STEP_SUMMARY
              echo "| Worker | âœ… Healthy | 100% | N/A |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ”— Application URLs" >> $GITHUB_STEP_SUMMARY
              echo "- **Vote App**: https://vote-voting01-qa.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
              echo "- **Result App**: https://result-voting01-qa.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
              echo "- **Argo Rollouts Dashboard**: https://rollouts-voting01-qa.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY

              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Check for degraded/failed
            if [ "$VOTE_PHASE" = "Degraded" ] || [ "$RESULT_PHASE" = "Degraded" ] || [ "$WORKER_PHASE" = "Degraded" ]; then
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘                    âŒ CANARY DEPLOYMENT FAILED - ROLLING BACK               â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

              # Get failure reason
              echo ""
              echo "ğŸ” Failure Analysis:"
              kubectl describe rollout vote -n $NS 2>/dev/null | grep -A5 "Message:" || true

              # Show analysis run failures
              echo ""
              echo "ğŸ“Š Failed Analysis Runs:"
              kubectl get analysisrun -n $NS -o jsonpath='{range .items[?(@.status.phase=="Failed")]}{.metadata.name}{"\t"}{.status.phase}{"\t"}{.status.message}{"\n"}{end}' 2>/dev/null || true

              # Update summary
              echo "| Vote | âŒ $VOTE_PHASE | ${VOTE_WEIGHT:-0}% | Failed |" >> $GITHUB_STEP_SUMMARY
              echo "| Result | âŒ $RESULT_PHASE | ${RESULT_WEIGHT:-0}% | Failed |" >> $GITHUB_STEP_SUMMARY
              echo "| Worker | âŒ $WORKER_PHASE | N/A | N/A |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Automatic rollback triggered** - canary analysis detected issues" >> $GITHUB_STEP_SUMMARY

              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi

            echo ""
            echo "â³ Waiting ${POLL_INTERVAL}s before next check..."
            sleep $POLL_INTERVAL
          done

          echo "â±ï¸ Timeout: Canary rollout did not complete within expected time" >> $GITHUB_STEP_SUMMARY
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFICATIONS
  # Note: Staging promotion is MANUAL - use "Promote to Staging" workflow
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  notify-slack:
    name: "ğŸ“¢ Slack"
    needs: [get-tag, deploy]
    if: always()
    runs-on: ${{ github.event.inputs.runner == 'self-hosted' && fromJSON('["self-hosted", "linux", "opsera"]') || 'ubuntu-latest' }}
    steps:
      - name: Determine Status
        id: status
        run: |
          if [ "${{ needs.deploy.outputs.success }}" = "true" ]; then
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "title=QA Canary Succeeded" >> $GITHUB_OUTPUT
          else
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "title=QA Canary Failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.title }} - voting01-qa",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.title }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*App:*\n`voting01`"},
                    {"type": "mrkdwn", "text": "*Environment:*\n`QA (Canary)`"},
                    {"type": "mrkdwn", "text": "*Tag:*\n`${{ needs.get-tag.outputs.image_tag }}`"},
                    {"type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [{
                    "type": "button",
                    "text": {"type": "plain_text", "text": "View Workflow"},
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
