# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# TEST JIRA INTEGRATION
# Standalone test to verify Jira ticket creation works
# Enhanced with quality-gate-failure test type for SonarQube integration testing
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: "üß™ Test Jira Integration"

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of Jira ticket to create'
        type: choice
        options: ['quality-gate-failure', 'security-vulnerability', 'deployment-failure', 'test-ticket']
        default: 'quality-gate-failure'
      jira_url_override:
        description: 'Override JIRA_BASE_URL (leave empty to use secret)'
        type: string
        default: ''
      api_version:
        description: 'Jira API version'
        type: choice
        options: ['2', '3']
        default: '2'
      auth_type:
        description: 'Authentication type'
        type: choice
        options: ['basic', 'api-key']
        default: 'api-key'
      # Mock SonarQube data for quality-gate-failure test
      mock_bugs:
        description: 'Mock bug count (quality-gate test)'
        type: string
        default: '5'
      mock_vulnerabilities:
        description: 'Mock vulnerability count (quality-gate test)'
        type: string
        default: '2'
      mock_code_smells:
        description: 'Mock code smell count (quality-gate test)'
        type: string
        default: '47'
      mock_coverage:
        description: 'Mock coverage % (quality-gate test)'
        type: string
        default: '42.5'
      mock_duplications:
        description: 'Mock duplication % (quality-gate test)'
        type: string
        default: '8.3'

jobs:
  test-jira:
    name: "üìã Test Jira"
    runs-on: ubuntu-latest
    steps:
      - name: Check Jira Configuration
        id: check-jira
        run: |
          echo "### üîç Jira Configuration Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          CONFIGURED="true"
          MISSING=""

          if [ -z "${{ secrets.JIRA_API_TOKEN }}" ]; then
            CONFIGURED="false"
            MISSING="${MISSING} JIRA_API_TOKEN"
            echo "‚ùå JIRA_API_TOKEN: Not configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ JIRA_API_TOKEN: Configured" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "${{ secrets.JIRA_EMAIL }}" ]; then
            # Email is optional for api-key auth
            echo "‚ö†Ô∏è JIRA_EMAIL: Not configured (optional for api-key auth)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ JIRA_EMAIL: Configured" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -z "${{ secrets.JIRA_BASE_URL }}" ]; then
            CONFIGURED="false"
            MISSING="${MISSING} JIRA_BASE_URL"
            echo "‚ùå JIRA_BASE_URL: Not configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ JIRA_BASE_URL: Configured" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "configured=${CONFIGURED}" >> $GITHUB_OUTPUT

          if [ "$CONFIGURED" = "false" ]; then
            echo "‚ö†Ô∏è **Missing secrets:**${MISSING}" >> $GITHUB_STEP_SUMMARY
            echo "Please configure the missing secrets in repository settings." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Test Jira API Connection
        if: steps.check-jira.outputs.configured == 'true'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_URL_SECRET: ${{ secrets.JIRA_BASE_URL }}
          JIRA_URL_OVERRIDE: ${{ github.event.inputs.jira_url_override }}
          API_VERSION: ${{ github.event.inputs.api_version }}
          AUTH_TYPE: ${{ github.event.inputs.auth_type }}
        run: |
          # Use override URL if provided, otherwise use secret
          if [ -n "$JIRA_URL_OVERRIDE" ]; then
            JIRA_BASE_URL="$JIRA_URL_OVERRIDE"
            echo "üîß Using override URL" >> $GITHUB_STEP_SUMMARY
          else
            JIRA_BASE_URL="$JIRA_BASE_URL_SECRET"
          fi

          echo "### üîå Testing Jira API Connection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Set auth header based on auth type
          if [ "$AUTH_TYPE" = "api-key" ]; then
            AUTH_HEADER="X-API-Key: ${JIRA_API_TOKEN}"
            echo "**Auth Type:** API Key (X-API-Key header)" >> $GITHUB_STEP_SUMMARY
          else
            AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_EMAIL}:${JIRA_API_TOKEN}" | base64)"
            echo "**Auth Type:** Basic (email:token)" >> $GITHUB_STEP_SUMMARY
          fi

          # Show URL for debugging
          echo "**Target:** \`${JIRA_BASE_URL}\`" >> $GITHUB_STEP_SUMMARY
          echo "**API Version:** \`${API_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test API connection - try project list (more reliable for mock)
          API_URL="${JIRA_BASE_URL}/rest/api/${API_VERSION}/project"
          echo "Making API call to ${API_URL}"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${API_URL}" 2>&1)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          echo "**HTTP Code:** \`$HTTP_CODE\`" >> $GITHUB_STEP_SUMMARY

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ **API Connection:** Success (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            PROJECT_COUNT=$(echo "$BODY" | jq 'length' 2>/dev/null || echo "0")
            echo "- Projects found: $PROJECT_COUNT" >> $GITHUB_STEP_SUMMARY
            # Get first project key
            FIRST_PROJECT=$(echo "$BODY" | jq -r '.[0].key // "TEST"')
            echo "- First project: $FIRST_PROJECT" >> $GITHUB_STEP_SUMMARY
            # Export for next steps
            echo "JIRA_BASE_URL=${JIRA_BASE_URL}" >> $GITHUB_ENV
            echo "FIRST_PROJECT=${FIRST_PROJECT}" >> $GITHUB_ENV
          else
            echo "‚ùå **API Connection:** Failed (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "Response: $BODY" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: List Available Projects
        if: steps.check-jira.outputs.configured == 'true'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          API_VERSION: ${{ github.event.inputs.api_version }}
          AUTH_TYPE: ${{ github.event.inputs.auth_type }}
        run: |
          echo "### üìÅ Available Jira Projects" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build auth header
          if [ "$AUTH_TYPE" = "api-key" ]; then
            AUTH_HEADER="X-API-Key: ${JIRA_API_TOKEN}"
          else
            AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_EMAIL}:${JIRA_API_TOKEN}" | base64)"
          fi

          RESPONSE=$(curl -s \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/${API_VERSION}/project")

          echo "| Key | Name |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|" >> $GITHUB_STEP_SUMMARY
          echo "$RESPONSE" | jq -r '.[] | "| \(.key) | \(.name) |"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "| - | No projects found |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Create Test Jira Ticket
        if: steps.check-jira.outputs.configured == 'true'
        id: create-ticket
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          API_VERSION: ${{ github.event.inputs.api_version }}
          AUTH_TYPE: ${{ github.event.inputs.auth_type }}
        run: |
          echo "### üìù Creating Test Jira Ticket" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build auth header
          if [ "$AUTH_TYPE" = "api-key" ]; then
            AUTH_HEADER="X-API-Key: ${JIRA_API_TOKEN}"
          else
            AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_EMAIL}:${JIRA_API_TOKEN}" | base64)"
          fi

          TEST_TYPE="${{ github.event.inputs.test_type }}"
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')

          # Use discovered project key from connection test, fallback to TEST
          PROJECT_KEY="${FIRST_PROJECT:-TEST}"
          echo "**Project:** \`${PROJECT_KEY}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type:** \`${TEST_TYPE}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          case "$TEST_TYPE" in
            "quality-gate-failure")
              # Mock SonarQube data from inputs
              MOCK_BUGS="${{ github.event.inputs.mock_bugs }}"
              MOCK_VULNS="${{ github.event.inputs.mock_vulnerabilities }}"
              MOCK_SMELLS="${{ github.event.inputs.mock_code_smells }}"
              MOCK_COVERAGE="${{ github.event.inputs.mock_coverage }}"
              MOCK_DUPS="${{ github.event.inputs.mock_duplications }}"

              # Calculate tech debt (mock: 15min per smell)
              TECH_DEBT_MINS=$((MOCK_SMELLS * 15))
              TECH_DEBT_HOURS=$((TECH_DEBT_MINS / 60))
              TECH_DEBT_REMAINING=$((TECH_DEBT_MINS % 60))
              TECH_DEBT="${TECH_DEBT_HOURS}h ${TECH_DEBT_REMAINING}m"

              # Mock failed conditions
              FAILED_CONDITIONS="- new_coverage: actual=${MOCK_COVERAGE} (threshold: 80.0)
- new_bugs: actual=${MOCK_BUGS} (threshold: 0)
- new_vulnerabilities: actual=${MOCK_VULNS} (threshold: 0)"

              # Mock issues list
              ISSUES_LIST="- [CRITICAL] SQL Injection vulnerability in user input handling (UserService.java:142)
- [CRITICAL] Hardcoded database credentials detected (DatabaseConfig.java:23)
- [MAJOR] Null pointer dereference possible (ApiController.java:89)
- [MAJOR] Resource leak - connection not closed (DataRepository.java:156)
- [MAJOR] Cognitive complexity too high (OrderProcessor.java:234)
- [MAJOR] Duplicate code block detected (ValidationUtils.java:45)
- [MINOR] Missing @Override annotation (BaseHandler.java:67)
- [MINOR] Unused import statement (TestHelper.java:12)
- [MINOR] Method parameter should be final (ConfigLoader.java:89)
- [MINOR] Empty catch block (ErrorHandler.java:34)"

              ISSUES_COUNT="127"

              SUMMARY="[QUALITY] voting01-dev: ${MOCK_BUGS} bugs, ${MOCK_VULNS} vulns - Quality Gate Failed"
              ISSUE_TYPE="Bug"

              # Determine priority
              if [ "${MOCK_BUGS:-0}" -gt 0 ] || [ "${MOCK_VULNS:-0}" -gt 0 ]; then
                PRIORITY="Highest"
              else
                PRIORITY="High"
              fi

              # Build comprehensive description matching main workflow format
              DESCRIPTION=$(cat << DESCEOF
SonarQube quality gate check FAILED for voting01-dev.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
QUALITY GATE STATUS: ERROR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä FAILED CONDITIONS:
${FAILED_CONDITIONS}

üìà CODE METRICS:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Metric          ‚îÇ Value      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Bugs            ‚îÇ ${MOCK_BUGS}            ‚îÇ
‚îÇ Vulnerabilities ‚îÇ ${MOCK_VULNS}            ‚îÇ
‚îÇ Code Smells     ‚îÇ ${MOCK_SMELLS}           ‚îÇ
‚îÇ Coverage        ‚îÇ ${MOCK_COVERAGE}%         ‚îÇ
‚îÇ Duplications    ‚îÇ ${MOCK_DUPS}%          ‚îÇ
‚îÇ Tech Debt       ‚îÇ ${TECH_DEBT}      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üêõ TOP ISSUES (${ISSUES_COUNT} total):
${ISSUES_LIST}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BUILD CONTEXT:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
- Commit: ${{ github.sha }}
- Branch: ${{ github.ref_name }}
- Triggered by: ${{ github.actor }}
- Event: workflow_dispatch (test)
- Timestamp: ${TIMESTAMP}

üîó LINKS:
- SonarQube Dashboard: https://sonarqube.example.com/dashboard?id=opsera-voting01
- GitHub Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
RECOMMENDED ACTIONS:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
1. Review the failed conditions above
2. Click the SonarQube Dashboard link for full issue details
3. Fix issues in priority order: Bugs > Vulnerabilities > Code Smells
4. Ensure coverage meets threshold requirements
5. Re-run the pipeline after fixes

---
‚ö†Ô∏è This is a TEST ticket created by the Jira integration test workflow.
DESCEOF
)
              ;;

            "security-vulnerability")
              SUMMARY="[TEST-SECURITY] voting01-dev: 3 Critical, 5 High vulnerabilities"
              ISSUE_TYPE="Task"
              PRIORITY="High"
              DESCRIPTION=$(cat << DESCEOF
Test security vulnerability ticket from CI/CD pipeline.

This is a test to verify Jira integration for security scan findings.

Security Scan Results (MOCK DATA):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Service   ‚îÇ Critical ‚îÇ High ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Vote      ‚îÇ 1        ‚îÇ 2    ‚îÇ
‚îÇ Result    ‚îÇ 1        ‚îÇ 2    ‚îÇ
‚îÇ Worker    ‚îÇ 1        ‚îÇ 1    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ TOTAL     ‚îÇ 3        ‚îÇ 5    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Test Details:
- Timestamp: ${TIMESTAMP}
- Workflow: ${{ github.workflow }}
- Run ID: ${{ github.run_id }}
- GitHub: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

---
‚ö†Ô∏è This is a TEST ticket.
DESCEOF
)
              ;;

            "deployment-failure")
              SUMMARY="[TEST-DEPLOY] voting01-dev Deployment Failed"
              ISSUE_TYPE="Task"
              PRIORITY="High"
              DESCRIPTION=$(cat << DESCEOF
Test deployment failure ticket from CI/CD pipeline.

This is a test to verify Jira integration for deployment failures.

Deployment Details (MOCK DATA):
- Environment: dev
- Image Tag: abc1234-20240115120000
- Status: FAILED
- Reason: Pod scheduling timeout (mock)

Test Details:
- Timestamp: ${TIMESTAMP}
- Workflow: ${{ github.workflow }}
- Run ID: ${{ github.run_id }}
- GitHub: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

---
‚ö†Ô∏è This is a TEST ticket.
DESCEOF
)
              ;;

            *)
              SUMMARY="[TEST] Jira Integration Test - ${TIMESTAMP}"
              ISSUE_TYPE="Task"
              PRIORITY="Medium"
              DESCRIPTION=$(cat << DESCEOF
Test ticket to verify Jira integration is working correctly.

Test Details:
- Timestamp: ${TIMESTAMP}
- Triggered by: ${{ github.actor }}
- Workflow: ${{ github.workflow }}
- Run ID: ${{ github.run_id }}
- Repository: ${{ github.repository }}
- GitHub: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

---
‚ö†Ô∏è This is a TEST ticket.
DESCEOF
)
              ;;
          esac

          # Use jq for safe JSON construction (handles special characters)
          PAYLOAD=$(jq -n \
            --arg project "$PROJECT_KEY" \
            --arg summary "$SUMMARY" \
            --arg description "$DESCRIPTION" \
            --arg issuetype "$ISSUE_TYPE" \
            --arg priority "$PRIORITY" \
            '{
              "fields": {
                "project": {"key": $project},
                "summary": $summary,
                "description": $description,
                "issuetype": {"name": $issuetype},
                "priority": {"name": $priority}
              }
            }')

          echo "Creating ticket with API v${API_VERSION}..."
          echo "Issue Type: ${ISSUE_TYPE}"
          echo "Priority: ${PRIORITY}"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/${API_VERSION}/issue" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          ISSUE_KEY=$(echo "$BODY" | jq -r '.key // "FAILED"')
          ISSUE_ID=$(echo "$BODY" | jq -r '.id // "FAILED"')

          if [ "$ISSUE_KEY" != "FAILED" ] && [ "$ISSUE_KEY" != "null" ] && [ "$HTTP_CODE" = "201" ]; then
            ISSUE_URL="${JIRA_BASE_URL}/browse/${ISSUE_KEY}"
            echo "‚úÖ **Ticket Created Successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Issue Key | [${ISSUE_KEY}](${ISSUE_URL}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Issue ID | ${ISSUE_ID} |" >> $GITHUB_STEP_SUMMARY
            echo "| Type | ${ISSUE_TYPE} |" >> $GITHUB_STEP_SUMMARY
            echo "| Test Type | ${TEST_TYPE} |" >> $GITHUB_STEP_SUMMARY
            echo "| Priority | ${PRIORITY} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üîó **[Open Ticket in Jira](${ISSUE_URL})**" >> $GITHUB_STEP_SUMMARY

            echo "issue_key=${ISSUE_KEY}" >> $GITHUB_OUTPUT
            echo "issue_url=${ISSUE_URL}" >> $GITHUB_OUTPUT
          else
            echo "‚ùå **Failed to create ticket** (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Error Response:**" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$BODY" | jq '.' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "$BODY" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Attempted Payload:**" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$PAYLOAD" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-jira.outputs.configured }}" != "true" ]; then
            echo "‚ùå **Result:** Jira secrets not configured" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ steps.create-ticket.outputs.issue_key }}" ]; then
            echo "‚úÖ **Result:** Jira integration working!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The CI/CD pipeline can now create Jira tickets for:" >> $GITHUB_STEP_SUMMARY
            echo "- üìä Quality gate failures (SonarQube)" >> $GITHUB_STEP_SUMMARY
            echo "- üîí Security vulnerability findings" >> $GITHUB_STEP_SUMMARY
            echo "- üö´ Deployment failures" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Ticket details include:**" >> $GITHUB_STEP_SUMMARY
            echo "- Failed quality gate conditions" >> $GITHUB_STEP_SUMMARY
            echo "- Code metrics (bugs, vulnerabilities, coverage, etc.)" >> $GITHUB_STEP_SUMMARY
            echo "- Top issues from scan with file:line references" >> $GITHUB_STEP_SUMMARY
            echo "- Links to SonarQube dashboard and workflow" >> $GITHUB_STEP_SUMMARY
            echo "- Recommended remediation actions" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Result:** Jira ticket creation failed" >> $GITHUB_STEP_SUMMARY
          fi
