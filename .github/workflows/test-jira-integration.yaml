# Test Jira API connectivity
name: "ðŸ§ª Test Jira"
on:
  workflow_dispatch:
jobs:
  test:
    name: "ðŸ“‹ Test Jira Ticket"
    runs-on: ubuntu-latest
    steps:
      - name: Create Test Ticket
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT }}
          JIRA_AUTH_TYPE: ${{ secrets.JIRA_AUTH_TYPE }}
        run: |
          if [ "$JIRA_AUTH_TYPE" = "api-key" ]; then
            AUTH_HEADER="X-API-Key: ${JIRA_API_TOKEN}"
          else
            AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_EMAIL}:${JIRA_API_TOKEN}" | base64)"
          fi

          PROJECT_KEY="${JIRA_PROJECT:-TEST}"
          TS=$(date -u +'%Y-%m-%d %H:%M UTC')

          PAYLOAD=$(jq -n \
            --arg project "$PROJECT_KEY" \
            --arg summary "[TEST] Jira Integration Verification - ${TS}" \
            --arg description "Test ticket from Opsera AI Agent. Created: ${TS}. Safe to close." \
            '{"fields":{"project":{"key":$project},"summary":$summary,"description":$description,"issuetype":{"name":"Task"},"priority":{"name":"Low"}}}')

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/2/issue" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          ISSUE_KEY=$(echo "$BODY" | jq -r '.key // "FAILED"')

          echo "HTTP: ${HTTP_CODE}"
          echo "Response: ${BODY}"

          if [ "$ISSUE_KEY" != "FAILED" ] && [ "$ISSUE_KEY" != "null" ] && [ "$HTTP_CODE" = "201" ]; then
            echo "### âœ… Jira Integration Working!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Ticket:** [${ISSUE_KEY}](${JIRA_BASE_URL}/browse/${ISSUE_KEY})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Issue Key | \`${ISSUE_KEY}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Project | \`${PROJECT_KEY}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| HTTP | ${HTTP_CODE} |" >> $GITHUB_STEP_SUMMARY
            echo "| Auth | ${JIRA_AUTH_TYPE:-basic} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Jira Integration Failed" >> $GITHUB_STEP_SUMMARY
            echo "**HTTP:** ${HTTP_CODE}" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$BODY" | jq '.' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "$BODY" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
