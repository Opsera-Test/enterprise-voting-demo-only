name: "99-Pod Logs (sperivote11)"

on:
  workflow_dispatch:

env:
  APP_NAME: sperivote11
  ENVIRONMENT: dev
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  logs:
    name: "ðŸ“‹ Pod Logs"
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        run: aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Get Pod Status
        run: |
          echo "### Pod Status" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -o wide
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Worker Logs
        run: |
          echo "### Worker Logs (last 50 lines)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -n ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -l app=worker --tail=50 >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No logs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Result Logs
        run: |
          echo "### Result Logs (last 30 lines)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl logs -n ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -l app=result --tail=30 >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No logs" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Worker Env Check
        run: |
          echo "### Worker Environment" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl exec -n ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} deploy/worker -- env | grep -E "(DATABASE|AWS|REDIS)" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Could not get env" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
