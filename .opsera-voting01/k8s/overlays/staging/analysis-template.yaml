# ════════════════════════════════════════════════════════════════════════════════
# PROMETHEUS-BASED ANALYSIS TEMPLATE - Staging Blue-Green
# Auto-rollback if error rate > 5% (success rate < 95%)
# ════════════════════════════════════════════════════════════════════════════════
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: voting01-bluegreen-analysis
  labels:
    app.kubernetes.io/name: voting01
    environment: staging
spec:
  args:
    - name: service-name
    - name: namespace
  metrics:
    # Primary: Prometheus-based error rate monitoring
    - name: prometheus-error-rate
      interval: 30s
      count: 10
      # Success if error rate < 5% (success rate >= 95%)
      successCondition: result[0] >= 0.95
      failureLimit: 3
      provider:
        prometheus:
          address: http://prometheus-server.monitoring.svc.cluster.local:9090
          query: |
            sum(rate(nginx_ingress_controller_requests{namespace="{{args.namespace}}",service="{{args.service-name}}",status!~"5.."}[1m]))
            /
            sum(rate(nginx_ingress_controller_requests{namespace="{{args.namespace}}",service="{{args.service-name}}"}[1m]))

    # Fallback: HTTP health check (runs in parallel)
    - name: http-health-check
      interval: 30s
      count: 10
      successCondition: result == "healthy"
      failureLimit: 2
      provider:
        job:
          spec:
            backoffLimit: 1
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: health-check
                    image: curlimages/curl:latest
                    command: ["/bin/sh", "-c"]
                    args:
                      - |
                        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://{{args.service-name}}.{{args.namespace}}.svc.cluster.local/" --max-time 10)
                        if [ "$HTTP_CODE" = "200" ]; then
                          echo "healthy"
                          exit 0
                        else
                          echo "unhealthy: HTTP $HTTP_CODE"
                          exit 1
                        fi
